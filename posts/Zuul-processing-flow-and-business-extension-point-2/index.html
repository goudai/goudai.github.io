<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Zuul源码分析(2)Filter分析 | 青木的博客</title>
    <meta property="og:title" content="Zuul源码分析(2)Filter分析 - 青木的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2018-11-26T23:19:17&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2018-11-26T23:19:17&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,青木,java,博客,项目管理,软件架构">
    <meta name="description" content="Zuul源码分析(2)Filter分析">
        
    <meta name="author" content="青木">
    <meta property="og:url" content="https://goudai.github.io/posts/Zuul-processing-flow-and-business-extension-point-2/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://goudai.github.io/">
                        青木的博客
                    </a>
                
                <p class="description">道可道，非常道；名可名，非常名。</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://goudai.github.io/">首页</a>
                    
                    <a  href="https://goudai.github.io/categories/" title="归档">归档</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#pre">Pre</a>
      <ul>
        <li><a href="#servletdetectionfilter顺序-servlet_detection_filter_order---3">ServletDetectionFilter(顺序 SERVLET_DETECTION_FILTER_ORDER = -3)</a></li>
        <li><a href="#servlet30wrapperfilter顺序-servlet_30_wrapper_filter_order---2">Servlet30WrapperFilter（顺序 SERVLET_30_WRAPPER_FILTER_ORDER = -2）</a></li>
        <li><a href="#formbodywrapperfilter顺序-form_body_wrapper_filter_order---1">FormBodyWrapperFilter（顺序 FORM_BODY_WRAPPER_FILTER_ORDER = -1）</a></li>
        <li><a href="#debugfilter顺序-debug_filter_order--1">DebugFilter（顺序 DEBUG_FILTER_ORDER = 1）</a></li>
        <li><a href="#predecorationfilter顺序-pre_decoration_filter_order--5">PreDecorationFilter（顺序 PRE_DECORATION_FILTER_ORDER = 5）</a></li>
      </ul>
    </li>
    <li><a href="#routefilter">RouteFilter</a>
      <ul>
        <li><a href="#ribbonroutingfilter顺序-ribbon_routing_filter_order--10">RibbonRoutingFilter（顺序 RIBBON_ROUTING_FILTER_ORDER = 10）</a></li>
        <li><a href="#simplehostroutingfilter-顺序-simple_host_routing_filter_order--100">SimpleHostRoutingFilter （顺序 SIMPLE_HOST_ROUTING_FILTER_ORDER = 100）</a></li>
        <li><a href="#sendforwardfilter-顺序-simple_host_routing_filter_order--500">SendForwardFilter （顺序 SIMPLE_HOST_ROUTING_FILTER_ORDER = 500）</a></li>
      </ul>
    </li>
    <li><a href="#postfilter">PostFilter</a>
      <ul>
        <li><a href="#locationrewritefilter-顺序-send_response_filter_order---100--1000---100--900">LocationRewriteFilter （顺序 SEND_RESPONSE_FILTER_ORDER - 100 = 1000 - 100 = 900）</a></li>
        <li><a href="#sendresponsefilter顺序-send_response_filter_order--1000">SendResponseFilter（顺序 SEND_RESPONSE_FILTER_ORDER = 1000）</a></li>
        <li><a href="#senderrorfilter顺序-send_error_filter_order--0">SendErrorFilter(顺序 SEND_ERROR_FILTER_ORDER = 0）</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">Zuul源码分析(2)Filter分析</h1>
        </header>
        <date class="post-meta meta-date">
            2018年11月26日
        </date>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h1 id="前言">前言</h1>
<p>在<a href="https://qingmu.io/2018/11/15/Zuul-processing-flow-and-business-extension-point/">前一篇</a>文件中我们分析了zuul对Filter请求了不同的阶段划分了多个生命周期即FilterType。接下来我们继续分析每一个FilterType的具体的Filter有哪些，他们都干了什么。</p>
<h1 id="zuulfilters运行流程图">ZuulFilters运行流程图</h1>
<ul>
<li>前面我们分析完了zuul的一个生命周期，下面我们在来仔细的看一下每个生命周期具体使用到的Filter</li>
</ul>
<!-- raw HTML omitted -->
<h2 id="pre">Pre</h2>
<ul>
<li>同样你可以在<code>spring-cloud-starter-netflix-zuul-2.0.2.RELEASE</code>包中找到我们的用到的代码片段。</li>
<li>图中被圈起来的代码就是zuul默认激活的Filter，接下来我们分别看下他们都在干嘛。
<!-- raw HTML omitted --></li>
<li>我们用debug的方式看看zuul激活的Pre的Filter
<!-- raw HTML omitted --></li>
<li>可以看到我们一共有7个PreFilter，除开两个我们自定义的Filter剩下5个都是zuul自带的，下面我们挨个看一下这些Filer到底干了些嘛事情。</li>
<li>一下我们只贴run()中的代码。</li>
</ul>
<h3 id="servletdetectionfilter顺序-servlet_detection_filter_order---3">ServletDetectionFilter(顺序 SERVLET_DETECTION_FILTER_ORDER = -3)</h3>
<ul>
<li>这个Filter主要是爬电请求是否来自于<code>DispatcherServlet</code>,并标记servlet的类型。</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  HttpServletRequest request <span style="color:#000;font-weight:bold">=</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!(</span>request <span style="color:#000;font-weight:bold">instanceof</span> HttpServletRequestWrapper<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">&amp;&amp;</span> isDispatcherServletRequest<span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">set</span><span style="color:#000;font-weight:bold">(</span>IS_DISPATCHER_SERVLET_REQUEST_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">set</span><span style="color:#000;font-weight:bold">(</span>IS_DISPATCHER_SERVLET_REQUEST_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isDispatcherServletRequest</span><span style="color:#000;font-weight:bold">(</span>HttpServletRequest request<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAttribute</span><span style="color:#000;font-weight:bold">(</span>DispatcherServlet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">WEB_APPLICATION_CONTEXT_ATTRIBUTE</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="servlet30wrapperfilter顺序-servlet_30_wrapper_filter_order---2">Servlet30WrapperFilter（顺序 SERVLET_30_WRAPPER_FILTER_ORDER = -2）</h3>
<ul>
<li>由于在zuul 1.2.2中存在一个错误，其中<code>HttpServletRequestWrapper.getRequest</code>返回一个包装请求而不是原始请求。这个Filter主要是目的是为了修复这个问题对HttpServletRequestWrapper进行包装，并覆盖 <code>HttpServletRequestWrapper.getRequest</code>.</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>	<span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		HttpServletRequest request <span style="color:#000;font-weight:bold">=</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 如果是已经包装过的类
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>request <span style="color:#000;font-weight:bold">instanceof</span> HttpServletRequestWrapper<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">// 反射取得HttpServletRequest
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>HttpServletRequest<span style="color:#000;font-weight:bold">)</span> ReflectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getField</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">requestField</span><span style="color:#000;font-weight:bold">,</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">// 重新包装之后设置到ctx中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Servlet30RequestWrapper<span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 这里其实就是使用了我们在前面Filter设置的IS_DISPATCHER_SERVLET_REQUEST_KEY的值。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>RequestUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isDispatcherServletRequest</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Servlet30RequestWrapper<span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// Servlet30RequestWrapper.java 这个类其实很简单 就是修复zuul 1.2.2中存在一个错误
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Servlet30RequestWrapper</span> <span style="color:#000;font-weight:bold">extends</span> HttpServletRequestWrapper <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000;font-weight:bold">private</span> HttpServletRequest request<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  	Servlet30RequestWrapper<span style="color:#000;font-weight:bold">(</span>HttpServletRequest request<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  		<span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  		<span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">request</span> <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000;font-weight:bold">public</span> HttpServletRequest <span style="color:#900;font-weight:bold">getRequest</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">request</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="formbodywrapperfilter顺序-form_body_wrapper_filter_order---1">FormBodyWrapperFilter（顺序 FORM_BODY_WRAPPER_FILTER_ORDER = -1）</h3>
<ul>
<li>该类主要是处理两种Content-Type,我们先看一下shouldFilter，</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">shouldFilter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  HttpServletRequest request <span style="color:#000;font-weight:bold">=</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  String contentType <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContentType</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 如果contextType则不进行处理
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>contentType <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#998;font-style:italic">// 这里很直观的可以看到主要是处理表单数据支持两种mediaType
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span> <span style="color:#998;font-style:italic">// 第一种是：APPLICATION_FORM_URLENCODED
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span> <span style="color:#998;font-style:italic">// 第二中是 DispatcherServlet &amp;&amp; MULTIPART_FORM_DATA
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    MediaType mediaType <span style="color:#000;font-weight:bold">=</span> MediaType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>contentType<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> MediaType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">APPLICATION_FORM_URLENCODED</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">includes</span><span style="color:#000;font-weight:bold">(</span>mediaType<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>isDispatcherServletRequest<span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> MediaType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">MULTIPART_FORM_DATA</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">includes</span><span style="color:#000;font-weight:bold">(</span>mediaType<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InvalidMediaTypeException ex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  HttpServletRequest request <span style="color:#000;font-weight:bold">=</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  FormBodyRequestWrapper wrapper <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 同理如果是被包装过的
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>request <span style="color:#000;font-weight:bold">instanceof</span> HttpServletRequestWrapper<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 反射取得HttpServletRequest
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  	HttpServletRequest wrapped <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>HttpServletRequest<span style="color:#000;font-weight:bold">)</span> ReflectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getField</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">requestField</span><span style="color:#000;font-weight:bold">,</span> request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//重新包装
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  	wrapper <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> FormBodyRequestWrapper<span style="color:#000;font-weight:bold">(</span>wrapped<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 反射覆盖request字段
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  	ReflectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setField</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">requestField</span><span style="color:#000;font-weight:bold">,</span> request<span style="color:#000;font-weight:bold">,</span> wrapper<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 如果是通过`/zuul` 的servlet进来的请求
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>request <span style="color:#000;font-weight:bold">instanceof</span> ServletRequestWrapper<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// 反射覆盖request字段
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  		ReflectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setField</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">servletRequestField</span><span style="color:#000;font-weight:bold">,</span> request<span style="color:#000;font-weight:bold">,</span> wrapper<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 如果没有被包装过，直接包装一下即可
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	wrapper <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> FormBodyRequestWrapper<span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRequest</span><span style="color:#000;font-weight:bold">(</span>wrapper<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>wrapper <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 将content-type放置到ctx中。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getZuulRequestHeaders</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;content-type&#34;</span><span style="color:#000;font-weight:bold">,</span> wrapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContentType</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这里的<code>FormBodyRequestWrapper</code>代码毕竟多，就不展开看了，有兴趣的老哥可以自己去翻阅。</li>
</ul>
<h3 id="debugfilter顺序-debug_filter_order--1">DebugFilter（顺序 DEBUG_FILTER_ORDER = 1）</h3>
<ul>
<li>这个类主要是判断用户是否携带debug参数，如果携带就设置一些标志位，就不展开了。</li>
</ul>
<h3 id="predecorationfilter顺序-pre_decoration_filter_order--5">PreDecorationFilter（顺序 PRE_DECORATION_FILTER_ORDER = 5）</h3>
<ul>
<li>这个类的代码行数相对较多，但是他确实只干两件事儿。设置serviceId,设置Header，都在为后面的具体route做准备。</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">final</span> String requestURI <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">urlPathHelper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPathWithinApplication</span><span style="color:#000;font-weight:bold">(</span>ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 通过URI获取到对应的路由信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//比如我们的请求是 mch-service/get 那么获取到的就是mch-servie为serviceId的路由
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>Route route <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">routeLocator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMatchingRoute</span><span style="color:#000;font-weight:bold">(</span>requestURI<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 如果匹配到有路由才进行处理
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>route <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 获取到location，如果是静态路由配置为（http://xxx）,如果是动态服务发现路由则是serviceId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	String location <span style="color:#000;font-weight:bold">=</span> route<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocation</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>location <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 添加path（/get）到ctx中方便后面直接使用
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>REQUEST_URI_KEY<span style="color:#000;font-weight:bold">,</span> route<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPath</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 添加PROXY_KEY到ctx中方便后面直接使用
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>PROXY_KEY<span style="color:#000;font-weight:bold">,</span> route<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 如果你配置了相关路由信息的header 将在这里处理
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>route<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isCustomSensitiveHeaders</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">proxyRequestHelper</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addIgnoredHeaders</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">properties</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSensitiveHeaders</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> String<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">]));</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">proxyRequestHelper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addIgnoredHeaders</span><span style="color:#000;font-weight:bold">(</span>route<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSensitiveHeaders</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> String<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">]));</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 取得getRetryable并放入ctx
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>route<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRetryable</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>RETRYABLE_KEY<span style="color:#000;font-weight:bold">,</span> route<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRetryable</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">//判断是否是配置的静态路由(http://xx.xx.com/users)，而非服务发现的服务
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>location<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span>HTTP_SCHEME<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;:&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> location<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span>HTTPS_SCHEME<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;:&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRouteHost</span><span style="color:#000;font-weight:bold">(</span>getUrl<span style="color:#000;font-weight:bold">(</span>location<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>		ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addOriginResponseHeader</span><span style="color:#000;font-weight:bold">(</span>SERVICE_HEADER<span style="color:#000;font-weight:bold">,</span> location<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>location<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span>FORWARD_LOCATION_PREFIX<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">set</span><span style="color:#000;font-weight:bold">(</span>FORWARD_TO_KEY<span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cleanPath</span><span style="color:#000;font-weight:bold">(</span>location<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">substring</span><span style="color:#000;font-weight:bold">(</span>FORWARD_LOCATION_PREFIX<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">+</span> route<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPath</span><span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>		ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRouteHost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// 设置serviceID，并清空静态路由的Host
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">set</span><span style="color:#000;font-weight:bold">(</span>SERVICE_ID_KEY<span style="color:#000;font-weight:bold">,</span> location<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRouteHost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addOriginResponseHeader</span><span style="color:#000;font-weight:bold">(</span>SERVICE_ID_HEADER<span style="color:#000;font-weight:bold">,</span> location<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#998;font-style:italic">//  ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 由于我们会在自定义的PRE路由设置好白名单UrlList 所有这里几乎走不过来
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	log<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;No route found for uri: &#34;</span> <span style="color:#000;font-weight:bold">+</span> requestURI<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="routefilter">RouteFilter</h2>
<ul>
<li>前置走了这么久，总算来到我们的具体请求发起阶段了，我们可以从下图看到至少两个信息。
第一个信息是zuul内置了3个RouteFilter，
第二个是Zuul默认支持使用<code>apacheHttpClient</code>和<code>okttp</code>发起请求。
<!-- raw HTML omitted --></li>
<li>下面我们就来具体的看一下这三个RouteFilter都在分别在做什么事情。</li>
</ul>
<h3 id="ribbonroutingfilter顺序-ribbon_routing_filter_order--10">RibbonRoutingFilter（顺序 RIBBON_ROUTING_FILTER_ORDER = 10）</h3>
<ul>
<li>我们分析的前置的Pre设置的相关信息都会在这里用到</li>
<li>先看RibbonRoutingFilter.shouldFilter</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">shouldFilter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 首先单独看看ctx.getRouteHost() == null &amp;&amp; ctx.get(SERVICE_ID_KEY) != null
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 结合上一个Filter设置的信息，很直观的能想到如果是静态路由配置，Ribbon压根管不着，直接不支持处理。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span>ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRouteHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>SERVICE_ID_KEY<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 这里判断了ctx中的sendZuulResponse是否为true，该值默认为true，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">//可想而知如果我们不想走RibbonRoutingFilter，则在PreFilter中调用ctx.setSendZuulResponse(false)即可。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">&amp;&amp;</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sendZuulResponse</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>在看具体的run方法，具体路由的操作。</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	RequestContext context <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addIgnoredHeaders</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 这里buildCommandContext方法主要是获取前置的Pre设置到ctx中的相关参数，并构造一个RibbonCommandContext返回
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		RibbonCommandContext commandContext <span style="color:#000;font-weight:bold">=</span> buildCommandContext<span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// forward内部其实也是委托给了ribbonCommandFactory的实现者去进行具体调用，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		ClientHttpResponse response <span style="color:#000;font-weight:bold">=</span> forward<span style="color:#000;font-weight:bold">(</span>commandContext<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 设置结果 其实就是将结果放到ctx（threadLocal中的zuulResponse属性）进行结果传递。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		setResponse<span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> response<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>ZuulException ex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> ZuulRuntimeException<span style="color:#000;font-weight:bold">(</span>ex<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception ex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> ZuulRuntimeException<span style="color:#000;font-weight:bold">(</span>ex<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">protected</span> RibbonCommandContext <span style="color:#900;font-weight:bold">buildCommandContext</span><span style="color:#000;font-weight:bold">(</span>RequestContext context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">//...其他代码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 这里取出来serviceId -&gt; mch-service
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	String serviceId <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">)</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>SERVICE_ID_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 这里取出来retryable
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	Boolean retryable <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>Boolean<span style="color:#000;font-weight:bold">)</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>RETRYABLE_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 该值并没有设置过，永远为null
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	Object loadBalancerKey <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>LOAD_BALANCER_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 在此方法可以看成是String uri = (String) context.get(REQUEST_URI_KEY);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	String uri <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">buildZuulRequestURI</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// remove double slashes
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	uri <span style="color:#000;font-weight:bold">=</span> uri<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;//&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#458;font-weight:bold">long</span> contentLength <span style="color:#000;font-weight:bold">=</span> useServlet31 <span style="color:#000;font-weight:bold">?</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContentLengthLong</span><span style="color:#000;font-weight:bold">():</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContentLength</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 获取完成相关参数构建请求对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RibbonCommandContext<span style="color:#000;font-weight:bold">(</span>serviceId<span style="color:#000;font-weight:bold">,</span> verb<span style="color:#000;font-weight:bold">,</span> uri<span style="color:#000;font-weight:bold">,</span> retryable<span style="color:#000;font-weight:bold">,</span> headers<span style="color:#000;font-weight:bold">,</span> params<span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			requestEntity<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">requestCustomizers</span><span style="color:#000;font-weight:bold">,</span> contentLength<span style="color:#000;font-weight:bold">,</span> loadBalancerKey<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">protected</span> ClientHttpResponse <span style="color:#900;font-weight:bold">forward</span><span style="color:#000;font-weight:bold">(</span>RibbonCommandContext context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 将Context传入到具体的实现中进行包装，返回具体的包装好httpclient的cmmand,而这个command其实就HystrixExecutable接口。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Zuul提供的默认实现有（HttpClientRibbonCommandFactory,OkHttpRibbonCommandFactory,RestClientRibbonCommandFactory）
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>RibbonCommand command <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ribbonCommandFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">create</span><span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 执行调用并获取到Htpp响应结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  ClientHttpResponse response <span style="color:#000;font-weight:bold">=</span> command<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">appendDebug</span><span style="color:#000;font-weight:bold">(</span>info<span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRawStatusCode</span><span style="color:#000;font-weight:bold">(),</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeaders</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> response<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>HystrixRuntimeException ex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 异常处理
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> handleException<span style="color:#000;font-weight:bold">(</span>info<span style="color:#000;font-weight:bold">,</span> ex<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 可以看到这里只有http请求异常时，才会触发
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> ClientHttpResponse <span style="color:#900;font-weight:bold">handleException</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> info<span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  HystrixRuntimeException ex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> ZuulException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> statusCode <span style="color:#000;font-weight:bold">=</span> HttpStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INTERNAL_SERVER_ERROR</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">value</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>Throwable cause <span style="color:#000;font-weight:bold">=</span> ex<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>String message <span style="color:#000;font-weight:bold">=</span> ex<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getFailureType</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ClientException clientException <span style="color:#000;font-weight:bold">=</span> findClientException<span style="color:#000;font-weight:bold">(</span>ex<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>clientException <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  clientException <span style="color:#000;font-weight:bold">=</span> findClientException<span style="color:#000;font-weight:bold">(</span>ex<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getFallbackException</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>clientException <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>clientException
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getErrorType</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> ClientException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ErrorType</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SERVER_THROTTLED</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    statusCode <span style="color:#000;font-weight:bold">=</span> HttpStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SERVICE_UNAVAILABLE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">value</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  cause <span style="color:#000;font-weight:bold">=</span> clientException<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  message <span style="color:#000;font-weight:bold">=</span> clientException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getErrorType</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>info<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;status&#34;</span><span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>statusCode<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 包装了相关信息并向上抛出。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> ZuulException<span style="color:#000;font-weight:bold">(</span>cause<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;Forwarding error&#34;</span><span style="color:#000;font-weight:bold">,</span> statusCode<span style="color:#000;font-weight:bold">,</span> message<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 设置结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">setResponse</span><span style="color:#000;font-weight:bold">(</span>ClientHttpResponse resp<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">throws</span> ClientException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;zuulResponse&#34;</span><span style="color:#000;font-weight:bold">,</span> resp<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 一下方法的调用会将返回的body的inputStream设置到ctx
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// context.setResponseDataStream(entity); 方便后面的fiter使用
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setResponse</span><span style="color:#000;font-weight:bold">(</span>resp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRawStatusCode</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>    resp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">:</span> resp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">(),</span> resp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeaders</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这个地方比较复杂，如果你还没理清楚，建议debug配合我的注解跟几次就十分清晰了。</li>
</ul>
<h3 id="simplehostroutingfilter-顺序-simple_host_routing_filter_order--100">SimpleHostRoutingFilter （顺序 SIMPLE_HOST_ROUTING_FILTER_ORDER = 100）</h3>
<ul>
<li>这里我不打算分析这个hostrouteFilter，因为在实际应用中我们的业务很少过静态路由设置。
我们这里看一下他会处理那些请求即可</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">shouldFilter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 从Ctx中获取Pre路由中这种的静态如有主机 如果有，并且需要进行发送响应到客户端
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">return</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getRouteHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">&amp;&amp;</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">sendZuulResponse</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sendforwardfilter-顺序-simple_host_routing_filter_order--500">SendForwardFilter （顺序 SIMPLE_HOST_ROUTING_FILTER_ORDER = 500）</h3>
<ul>
<li>这个<code>SendForwardFilter</code>其实就调用了我们熟悉的<code>HttpServletRquest.getRequestDispatcher.forward(ctx.getRequest(), ctx.getResponse())</code>基本用不上。</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    String path <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">)</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>FORWARD_TO_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    RequestDispatcher dispatcher <span style="color:#000;font-weight:bold">=</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getRequestDispatcher</span><span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>dispatcher <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">set</span><span style="color:#000;font-weight:bold">(</span>SEND_FORWARD_FILTER_RAN<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponse</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isCommitted</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// 熟悉的forward
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        dispatcher<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forward</span><span style="color:#000;font-weight:bold">(</span>ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">(),</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponse</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponse</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">flushBuffer</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception ex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    ReflectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">rethrowRuntimeException</span><span style="color:#000;font-weight:bold">(</span>ex<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="postfilter">PostFilter</h2>
<ul>
<li>路由完成之后的结果会走到这里来。</li>
</ul>
<h3 id="locationrewritefilter-顺序-send_response_filter_order---100--1000---100--900">LocationRewriteFilter （顺序 SEND_RESPONSE_FILTER_ORDER - 100 = 1000 - 100 = 900）</h3>
<ul>
<li>主要处理3XX重定向请求，基本用不上，不多说。</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">shouldFilter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#458;font-weight:bold">int</span> statusCode <span style="color:#000;font-weight:bold">=</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponseStatusCode</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">//这里主要是处理HTTP CODE
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> HttpStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>statusCode<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">is3xxRedirection</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sendresponsefilter顺序-send_response_filter_order--1000">SendResponseFilter（顺序 SEND_RESPONSE_FILTER_ORDER = 1000）</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 添加响应头信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>addResponseHeaders<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 写会结果到请求发起方
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>writeResponse<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception ex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">//异常向上抛出
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	ReflectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">rethrowRuntimeException</span><span style="color:#000;font-weight:bold">(</span>ex<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="senderrorfilter顺序-send_error_filter_order--0">SendErrorFilter(顺序 SEND_ERROR_FILTER_ORDER = 0）</h3>
<ul>
<li>在实际业务中我们一般采用直接继承该类的方式来轻松扩展它，完成业务相关异常的信息转换。</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">shouldFilter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  RequestContext ctx <span style="color:#000;font-weight:bold">=</span> RequestContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCurrentContext</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 由于异常会向上抛出的同时会设置到ctx中，这里统一全局处理掉网关抛出的异常。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getThrowable</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBoolean</span><span style="color:#000;font-weight:bold">(</span>SEND_ERROR_FILTER_RAN<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://goudai.github.io/">青木</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://goudai.github.io/posts/Zuul-processing-flow-and-business-extension-point-2/">https://goudai.github.io/posts/Zuul-processing-flow-and-business-extension-point-2/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/posts/Zuul-processing-flow-and-business-extension-point/">Zuul源码分析(1)生命周期</a></li>
        
        <li><a href="/posts/How-to-upgrade-SpringCloud1-x-to-2-x/">记SpringCloud 1.X 升级到2.x</a></li>
        
        <li><a href="/images/How-to-handle-exceptions-gracefully-in-springcloud/">如何构建springcloud微服务中的异常处理体系</a></li>
        
        <li><a href="/posts/How-to-run-springcloud-in-docker/">如何构建SpringBoot的Docker镜像</a></li>
        
        <li><a href="/posts/How-to-monitor-springboot-application/">如何监控springboot应用</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/zuul'>zuul</a></li>
                
                <li><a href='/tags/%E6%BA%90%E7%A0%81'>源码</a></li>
                
                <li><a href='/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1'>微服务</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2022 <a href="https://goudai.github.io/">青木的博客 By 青木</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>



        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://goudai.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://goudai.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://goudai.github.io/posts/Spring-Boot-Operator-User-Guide/" title="使用Spring Boot Operator部署SpringBoot到K8S">使用Spring Boot Operator部署SpringBoot到K8S</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Monitor-ETCD/" title="Prometheus Operator监控ETCD">Prometheus Operator监控ETCD</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Monitor-springboot-microservices/" title="Prometheus Operator监控SpringCloud">Prometheus Operator监控SpringCloud</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Customize-your-kube-prometheus/" title="优雅的使用Prometheus Operator">优雅的使用Prometheus Operator</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Run-the-business-service-to-complete-the-service-call-using-Feign/" title="部署业务并使用Feign进行服务间调用（附带一部分源码分析）">部署业务并使用Feign进行服务间调用（附带一部分源码分析）</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Run-mysql-on-kubernetes/" title="从部署mysql聊一聊有状态服务和PV及PVC">从部署mysql聊一聊有状态服务和PV及PVC</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Run-distributed-trace-zipkin-in-kubernetes/" title="在kubernetes运行分布式追踪zipkin">在kubernetes运行分布式追踪zipkin</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Run-the-configuration-hub-cluster-on-kubernetes/" title="在kubernetes上运行SpringCloud配置中心">在kubernetes上运行SpringCloud配置中心</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Run-eureka-cluster-on-kubernetes/" title="在kubernetes上运行eureka集群">在kubernetes上运行eureka集群</a>
    </li>
    
    <li>
        <a href="https://goudai.github.io/posts/Run-Spring-Cloud-Gateway-on-kubernetes-2/" title="在kubernetes上运行Spring Cloud Gateway（二）">在kubernetes上运行Spring Cloud Gateway（二）</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://goudai.github.io/categories/%E5%90%8E%E7%AB%AF/">后端 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://goudai.github.io/tags/EFK/">EFK</a>
    
    <a href="https://goudai.github.io/tags/Java/">Java</a>
    
    <a href="https://goudai.github.io/tags/kubernetes/">kubernetes</a>
    
    <a href="https://goudai.github.io/tags/Mysql/">Mysql</a>
    
    <a href="https://goudai.github.io/tags/Prometheus/">Prometheus</a>
    
    <a href="https://goudai.github.io/tags/SpringBoot/">SpringBoot</a>
    
    <a href="https://goudai.github.io/tags/SpringCloud/">SpringCloud</a>
    
    <a href="https://goudai.github.io/tags/SpringGateway/">SpringGateway</a>
    
    <a href="https://goudai.github.io/tags/docker/">docker</a>
    
    <a href="https://goudai.github.io/tags/elasticsearch/">elasticsearch</a>
    
    <a href="https://goudai.github.io/tags/gitlab/">gitlab</a>
    
    <a href="https://goudai.github.io/tags/hpa/">hpa</a>
    
    <a href="https://goudai.github.io/tags/jvm/">jvm</a>
    
    <a href="https://goudai.github.io/tags/kafka/">kafka</a>
    
    <a href="https://goudai.github.io/tags/kubernetes/">kubernetes</a>
    
    <a href="https://goudai.github.io/tags/metrics-server/">metrics-server</a>
    
    <a href="https://goudai.github.io/tags/springclod/">springclod</a>
    
    <a href="https://goudai.github.io/tags/zuul/">zuul</a>
    
    <a href="https://goudai.github.io/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">异常处理</a>
    
    <a href="https://goudai.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
    
    <a href="https://goudai.github.io/tags/%E6%BA%90%E7%A0%81/">源码</a>
    
    <a href="https://goudai.github.io/tags/%E7%9B%91%E6%8E%A7/">监控</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://goudai.github.io/" title="青木的博客">青木的博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://goudai.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>